<style>
  #sidebar-graph-wrapper {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(241, 245, 249, 0.95));
    border-radius: 12px;
    height: 200px;
    position: relative;
    overflow: hidden;
  }

  #sidebar-graph-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(circle at 30% 30%, rgba(16, 185, 129, 0.06) 0%, transparent 50%),
      radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.06) 0%, transparent 50%);
    pointer-events: none;
  }

  #sidebar-graph-wrapper svg {
    width: 100%;
    height: 100%;
  }

  .sidebar-graph .nodes circle {
    cursor: pointer;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
  }

  .sidebar-graph .links line {
    stroke: rgba(156, 163, 175, 0.4);
    stroke-width: 1;
  }

  .sidebar-graph .text text {
    font-size: 9px;
    fill: #4B5563;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .sidebar-graph .inactive { opacity: 0.2; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const wrapper = document.getElementById('sidebar-graph-wrapper');
  if (!wrapper) return;

  const category = wrapper.dataset.category;

  // Load D3 if not already loaded
  if (typeof d3 === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js';
    script.onload = initSidebarGraph;
    document.body.appendChild(script);
  } else {
    initSidebarGraph();
  }

  function initSidebarGraph() {
    const graphData = {% include notes_graph.json %};

    // Filter nodes by category
    const filteredNodes = graphData.nodes.filter(n =>
      n.category === category
    );

    const nodeIds = new Set(filteredNodes.map(n => n.id));

    // Filter edges to only include connections between filtered nodes
    const filteredEdges = graphData.edges.filter(e =>
      nodeIds.has(e.source) && nodeIds.has(e.target)
    );

    if (filteredNodes.length === 0) {
      wrapper.innerHTML = '<p style="padding: 1rem; color: #9CA3AF; font-size: 0.8rem; text-align: center;">No related notes</p>';
      return;
    }

    const width = wrapper.offsetWidth;
    const height = 200;

    const svg = d3.select('#sidebar-graph-wrapper')
      .append('svg')
      .attr('width', width)
      .attr('height', height);

    const g = svg.append('g');

    // Category colors
    const getColor = (cat) => {
      if (cat === 'investing') return '#10B981';
      if (cat === 'theory') return '#3B82F6';
      if (cat === 'dev') return '#8B5CF6';
      if (cat === 'ai') return '#F59E0B';
      return '#6B7280';
    };

    const simulation = d3.forceSimulation(filteredNodes)
      .force('link', d3.forceLink(filteredEdges).id(d => d.id).distance(40))
      .force('charge', d3.forceManyBody().strength(-50))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(25));

    const link = g.append('g')
      .attr('class', 'links')
      .selectAll('line')
      .data(filteredEdges)
      .enter().append('line');

    const node = g.append('g')
      .attr('class', 'nodes')
      .selectAll('circle')
      .data(filteredNodes)
      .enter().append('circle')
      .attr('r', d => isCurrentPath(d.path) ? 8 : 5)
      .attr('fill', d => getColor(d.category))
      .attr('opacity', d => isCurrentPath(d.path) ? 1 : 0.7)
      .style('cursor', 'pointer')
      .on('click', d => { window.location = d.path; });

    const text = g.append('g')
      .attr('class', 'text')
      .selectAll('text')
      .data(filteredNodes)
      .enter().append('text')
      .text(d => d.label.length > 12 ? d.label.substring(0, 12) + '...' : d.label)
      .attr('text-anchor', 'middle')
      .attr('dy', -10)
      .attr('font-weight', d => isCurrentPath(d.path) ? '600' : '400')
      .style('cursor', 'pointer')
      .on('click', d => { window.location = d.path; });

    // Hover effects
    node.on('mouseover', function(d) {
      const related = new Set([d.id]);
      filteredEdges.forEach(e => {
        if (e.source.id === d.id) related.add(e.target.id);
        if (e.target.id === d.id) related.add(e.source.id);
      });
      node.attr('class', n => related.has(n.id) ? '' : 'inactive');
      text.attr('class', n => related.has(n.id) ? '' : 'inactive');
      link.attr('class', l => (l.source.id === d.id || l.target.id === d.id) ? '' : 'inactive');
    }).on('mouseout', function() {
      node.attr('class', '');
      text.attr('class', '');
      link.attr('class', '');
    });

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);
      text
        .attr('x', d => d.x)
        .attr('y', d => d.y);
    });

    // Zoom
    svg.call(d3.zoom().scaleExtent([0.5, 2]).on('zoom', () => {
      g.attr('transform', d3.event.transform);
    }));

    function isCurrentPath(path) {
      return window.location.pathname.includes(path);
    }
  }
});
</script>
